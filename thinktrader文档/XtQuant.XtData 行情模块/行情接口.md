# 行情接口

## 订阅单股行情

    subscribe_quote(stock_code, period='1d', start_time='', end_time='', count=0, callback=None)
    

*   释义
    
    *   订阅单股的行情数据，返回订阅号
    *   数据推送从callback返回，数据类型和period指定的周期对应
    *   数据范围代表请求的历史部分的数据范围，数据返回后会进入缓存，用于保证数据连续，通常情况仅订阅数据时传`count = 0`即可
*   参数
    
    *   stock\_code - string 合约代码
        
    *   period - string 周期
        
    *   start\_time - string 起始时间
        
    *   end\_time - string 结束时间
        
    *   count - int 数据个数
        
    *   callback - 数据推送回调
        
        *   回调定义形式为`on_data(datas)`，回调参数`datas`格式为 { stock\_code : \[data1, data2, ...\] }
        
            def on_data(datas):
                for stock_code in datas:
                    	print(stock_code, datas[stock_code])
            
        
*   返回
    
    *   订阅号，订阅成功返回`大于0`，失败返回`-1`
*   备注
    
    *   单股订阅数量不宜过多，详见 接口概述-请求限制

## 订阅全推行情

    subscribe_whole_quote(code_list, callback=None)
    

*   释义
    
    *   订阅全推行情数据，返回订阅号
    *   数据推送从callback返回，数据类型为分笔数据
*   参数
    
    *   code\_list - 代码列表，支持传入市场代码或合约代码两种方式
        
        *   传入市场代码代表订阅全市场，示例：`['SH', 'SZ']`
        *   传入合约代码代表订阅指定的合约，示例：`['600000.SH', '000001.SZ']`
    *   callback - 数据推送回调
        
        *   回调定义形式为`on_data(datas)`，回调参数`datas`格式为 { stock1 : data1, stock2 : data2, ... }
        
            def on_data(datas):
                for stock_code in datas:
                    	print(stock_code, datas[stock_code])
            
        
*   返回
    
    *   订阅号，订阅成功返回`大于0`，失败返回`-1`
*   备注
    
    *   订阅后会首先返回当前最新的全推数据

## 反订阅行情数据

    unsubscribe_quote(seq)
    

*   释义
    *   反订阅行情数据
*   参数
    *   seq - 订阅时返回的订阅号
*   返回
    *   无
*   备注
    *   无

## 阻塞线程接收行情回调

    run()
    

*   释义
    *   阻塞当前线程来维持运行状态，一般用于订阅数据后维持运行状态持续处理回调
*   参数
    *   seq - 订阅时返回的订阅号
*   返回
    *   无
*   备注
    *   实现方式为持续循环sleep，并在唤醒时检查连接状态，若连接断开则抛出异常结束循环

## 订阅模型

    subscribe_formula(formula_name, stock_code, period, start_time = '', end_time = '', count = -1, dividend_type = None, extend_param = {}, callback = None)
    

*   释义
    *   订阅vba模型运行结果，需连接投研端使用
*   参数
    *   formula\_name:str,模型名
        
    *   stock\_code:str,模型主图代码形式如'stkcode.market',如'000300.SH'；
        
    *   period:str,K线周期类型 可选范围： 'tick':分笔线 '1d':日线 '1m':分钟线 '3m':三分钟线 '5m':5分钟线 '15m':15分钟线 '30m':30分钟线 '1h':小时线 '1w':周线 '1mon':月线 '1q':季线 '1hy':半年线 '1y':年线
        
    *   start\_time:str,模型运行起始时间,形如:'20200101';默认为空视为最早
        
    *   end\_time:str,模型运截止时间,形如:'20200101';默认为空视为最新
        
    *   count:int,模型运行范围为向前count根bar,默认为-1运行所有bar
        
    *   dividend\_type:str,复权方式,默认为主图除权方式,可选范围： 'none':不复权 'front':向前复权 'back':向后复权 'front\_ratio':等比向前复权 'back\_ratio':等比向后复权
        
    *   extend\_param:dict,模型的入参,{参数名:参数值},形如{'a':1,'\_\_basket':{}};
        
    *   \_\_basket:dict,可选参数,组合模型的股票池权重,形如{'600000.SH':0.06,'000001.SZ':0.01}
        
*   返回：
    *   int 订阅成功时为订阅ID，可用于后续反订阅,失败返回-1
*   备注:
    *   使用该函数时需要补充号本地K线或分笔数据

## 反订阅模型

    unsubscribe_formula(subID)
    

*   释义
    *   反订阅模型
*   参数
    *   subID:int 模型订阅号
*   返回
    *   bool ,反订阅成功为True,失败为False

## 调用模型

    call_formula(formula_name,stock_code,period,start_time="",end_time="",count=-1,dividend_type="none",extend_param={})
    

*   释义
    
    *   获取vba模型运行结果，使用前要注意补充本地K线数据或分笔数据
*   参数：
    
    *   formula\_name: str，模型名称名
    *   stock\_code: str，模型主图代码形式如'stkcode.market'，如'000300.SH'
    *   period: str，K线周期类型
        *   可选范围：
            *   'tick': 分笔线
            *   '1d': 日线
            *   '1m': 分钟线
            *   '3m': 三分钟线
            *   '5m': 5分钟线
            *   '15m': 15分钟线
            *   '30m': 30分钟线
            *   '1h': 小时线
            *   '1w': 周线
            *   '1mon': 月线
            *   '1q': 季线
            *   '1hy': 半年线
            *   '1y': 年线
    *   start\_time: str，模型运行起始时间，形如:'20200101'，默认为空视为最早
    *   end\_time: str，模型运行截止时间，形如:'20200101'，默认为空视为最新
    *   count: int，模型运行范围为向前 count 根 bar，默认为 -1 运行所有 bar
    *   dividend\_type: str，复权方式，默认为主图除权方式
        *   可选范围：
            *   'none': 不复权
            *   'front': 向前复权
            *   'back': 向后复权
            *   'front\_ratio': 等比向前复权
            *   'back\_ratio': 等比后复权
    *   extend\_param: dict，模型的入参，例如 {"模型名:参数名": 参数值}，例如在跑模型 MA 时，{'MA:n1': 1}
        *   入参可以添加 `__basket: dict`，组合模型的股票池权重，形如 `{'__basket': {'600000.SH': 0.06, '000001.SZ': 0.01}}`
        *   如果在跑一个模型1的时候，模型1调用了模型2，如果只想修改模型2的参数可以传 `{'模型2: 参数': 参数值}`
*   返回
    
    *   dict{ 'dbt':0,#返回数据类型，0:全部历史数据 'timelist':\[...\],#返回数据时间范围list, 'outputs':{'var1':\[...\],'var2':\[...\]}#输出变量名：变量值list }

## 批量调用模型

    call_formula_batch(formula_names,stock_codes,period,start_time="",end_time="",count=-1,dividend_type="none",extend_params=[])
    

*   释义
    
    *   批量获取vba模型运行结果，使用前要注意补充本地K线数据或分笔数据
*   参数：
    
    *   formula\_names: list，包含要批量运行的模型名
    *   stock\_codes: list，包含要批量运行的模型主图代码形式 'stkcode.market'，如 '000300.SH'
    *   period: str，K线周期类型
        *   可选范围：
            *   'tick': 分笔线
            *   '1d': 日线
            *   '1m': 分钟线
            *   '3m': 三分钟线
            *   '5m': 5分钟线
            *   '15m': 15分钟线
            *   '30m': 30分钟线
            *   '1h': 小时线
            *   '1w': 周线
            *   '1mon': 月线
            *   '1q': 季线
            *   '1hy': 半年线
            *   '1y': 年线
    *   start\_time: str，模型运行起始时间，形如:'20200101'，默认为空视为最早
    *   end\_time: str，模型运行截止时间，形如:'20200101'，默认为空视为最新
    *   count: int，模型运行范围为向前 count 根 bar，默认为 -1 运行所有 bar
    *   dividend\_type: str，复权方式，默认为主图除权方式
        *   可选范围：
            *   'none': 不复权
            *   'front': 向前复权
            *   'back': 向后复权
            *   'front\_ratio': 等比向前复权
            *   'back\_ratio': 等比后复权
    *   extend\_params: list，包含每个模型的入参，形如 \[{"模型名:参数名": 参数值}\]，例如在跑模型 MA 时，{'MA:n1': 1}
        *   入参可以添加 `__basket: dict`，组合模型的股票池权重，形如 `{'__basket': {'600000.SH': 0.06, '000001.SZ': 0.01}}`
        *   如果在跑一个模型1的时候，模型1调用了模型2，如果只想修改模型2的参数可以传 `{'模型2: 参数': 参数值}`
*   返回
    
    *   list\[dict\]
        *   dict说明:
            *   formula:模型名
            *   stock:品种代码
            *   argument:参数
            *   result:dict参考call\_formula返回结果

## 生成因子数据

    generate_index_data(formula_name, formula_param = {}, stock_list = [], period = '1d', dividend_type = 'none', start_time = '', end_time = '', fill_mode = 'fixed', fill_value = float('nan'), result_path = None)
    

*   释义
    
    *   在本地生成因子数据文件，文件格式为feather
*   参数
    
    *   formula\_name:str 模型名称
    *   formula\_param:dict 模型参数,例如 {'param1': 1.0, 'param2': 'sym'}
    *   stock\_list:list 股票列表
    *   period:str 周期
        *   可选范围
            *   '1m' '5m' '1d'
    *   dividend\_type:str 复权方式
        *   可选范围
            *   'none' - 不复权
            *   'front\_ratio' - 等比前复权
            *   'back\_ratio' - 等比后复权
    *   start\_time:str 起始时间 格式为'20240101' 或 '20240101000000'
    *   end\_time: str 结束时间 格式为'20241231' 或 '20241231235959'
    *   fill\_mode:str 空缺填充方式
        *   可选范围
            *   'fixed' - 固定值填充
            *   'forward' - 向前延续
    *   fill\_value:float 填充数值
        *   float('nan') - 以NaN填充
    *   result\_path:str 结果文件路径，feather格式
*   返回 None
    
*   备注 必须连接投研端使用，传入的formula\_name需要存在于投研端中
    

## 获取行情数据

    get_market_data(field_list=[], stock_list=[], period='1d', start_time='', end_time='', count=-1, dividend_type='none', fill_data=True)
    

*   释义
    *   从缓存获取行情数据，是主动获取行情的主要接口
*   参数
    *   field\_list - list 数据字段列表，传空则为全部字段
    *   stock\_list - list 合约代码列表
    *   period - string 周期
    *   start\_time - string 起始时间
    *   end\_time - string 结束时间
    *   count - int 数据个数
    *   默认参数，大于等于0时，若指定了start\_time，end\_time，此时以end\_time为基准向前取count条；若start\_time，end\_time缺省，默认取本地数据最新的count条数据；若start\_time，end\_time，count都缺省时，默认取本地全部数据
    *   dividend\_type - string 除权方式
    *   fill\_data - bool 是否向后填充空缺数据
*   返回
    *   period为`1m` `5m` `1d`等K线周期时
        *   返回dict { field1 : value1, field2 : value2, ... }
        *   field1, field2, ... ：数据字段
        *   value1, value2, ... ：pd.DataFrame 数据集，index为stock\_list，columns为time\_list
        *   各字段对应的DataFrame维度相同、索引相同
    *   period为`tick`分笔周期时
        *   返回dict { stock1 : value1, stock2 : value2, ... }
        *   stock1, stock2, ... ：合约代码
        *   value1, value2, ... ：np.ndarray 数据集，按数据时间戳`time`增序排列
*   备注
    *   获取lv2数据时需要数据终端有lv2数据权限
    *   时间范围为闭区间

## 获取本地行情数据

    get_local_data(field_list=[], stock_list=[], period='1d', start_time='', end_time='', count=-1,
                   dividend_type='none', fill_data=True, data_dir=data_dir)
    

*   释义
    *   从本地数据文件获取行情数据，用于快速批量获取历史部分的行情数据
*   参数
    *   field\_list - list 数据字段列表，传空则为全部字段
    *   stock\_list - list 合约代码列表
    *   period - string 周期
    *   start\_time - string 起始时间
    *   end\_time - string 结束时间
    *   count - int 数据个数
    *   dividend\_type - string 除权方式
    *   fill\_data - bool 是否向后填充空缺数据
    *   data\_dir - string MiniQmt配套路径的userdata\_mini路径，用于直接读取数据文件。默认情况下xtdata会通过连接向MiniQmt直接获取此路径，无需额外设置。如果需要调整，可以将数据路径作为`data_dir`传入，也可以直接修改`xtdata.data_dir`以改变默认值
*   返回
    *   period为`1m` `5m` `1d`K线周期时
        *   返回dict { field1 : value1, field2 : value2, ... }
        *   field1, field2, ... ：数据字段
        *   value1, value2, ... ：pd.DataFrame 数据集，index为stock\_list，columns为time\_list
        *   各字段对应的DataFrame维度相同、索引相同
    *   period为`tick`分笔周期时
        *   返回dict { stock1 : value1, stock2 : value2, ... }
        *   stock1, stock2, ... ：合约代码
        *   value1, value2, ... ：np.ndarray 数据集，按数据时间戳`time`增序排列
*   备注
    *   仅用于获取level1数据

## 获取全推数据

    get_full_tick(code_list)
    

*   释义
    *   获取全推数据
*   参数
    *   code\_list - 代码列表，支持传入市场代码或合约代码两种方式
        *   传入市场代码代表订阅全市场，示例：`['SH', 'SZ']`
        *   传入合约代码代表订阅指定的合约，示例：`['600000.SH', '000001.SZ']`
*   返回
    *   dict 数据集 { stock1 : data1, stock2 : data2, ... }
*   备注
    *   无

## 获取除权数据

    get_divid_factors(stock_code, start_time='', end_time='')
    

*   释义
    *   获取除权数据
*   参数
    *   stock\_code - 合约代码
    *   start\_time - string 起始时间
    *   end\_time - string 结束时间
*   返回
    *   pd.DataFrame 数据集
*   备注
    *   无

## 下载历史行情数据

    download_history_data(stock_code, period, start_time='', end_time='', incrementally = None)
    

*   释义
    *   补充历史行情数据
*   参数
    *   stock\_code - string 合约代码
    *   period - string 周期
    *   start\_time - string 起始时间
    *   end\_time - string 结束时间
    *   incrementally - 是否增量下载
        *   `bool` - 是否增量下载
        *   `None` - 使用`start_time`控制，`start_time`为空则增量下载，增量下载时会从本地最后一条数据往后下载
*   返回
    *   无
*   备注
    *   同步执行，补充数据完成后返回

    download_history_data2(stock_list, period, start_time='', end_time='', callback=None,incrementally = None)
    

*   释义
    
    *   补充历史行情数据，批量版本
*   参数
    
    *   stock\_list - list 合约列表
        
    *   period - string 周期
        
    *   start\_time - string 起始时间
        
    *   end\_time - string 结束时间
        
    *   callback - func 回调函数
        
        *   参数为进度信息dict
            
            *   total - 总下载个数
            *   finished - 已完成个数
            *   stockcode - 本地下载完成的合约代码
            *   message - 本次信息
        *       def on_progress(data):
                	print(data)
                	# {'finished': 1, 'total': 50, 'stockcode': '000001.SZ', 'message': ''}
                
            
*   返回
    
    *   无
*   备注
    
    *   同步执行，补充数据完成后返回
    *   有任务完成时通过回调函数返回进度信息

## 下载过期（退市）合约信息

    download_history_contracts()
    

*   释义
    *   下载过期（退市）合约信息，过期（退市）标的列表可以通过get\_stock\_list\_in\_sector获取
*   参数
    *   None
*   返回
    *   无
*   备注
    *   同步执行，补充数据完成后返回
    *   过期板块名称可以通过 `print([i for i in xtdata.get_sector_list() if "过期" in i])` 查看
    *   下载完成后，可以通过 `xtdata.get_instrument_detail()` 查看过期（退市）合约信息

## 获取节假日数据

    get_holidays()
    

*   释义
    *   获取截止到当年的节假日日期
*   参数
    *   无
*   返回
    *   list，为8位的日期字符串格式
*   备注
    *   无

## 获取交易日历

    get_trading_calendar(market, start_time = '', end_time = '')
    

*   释义
    *   获取指定市场交易日历
*   参数
    *   market - str 市场
    *   start\_time - str 起始时间，8位字符串。为空表示当前市场首个交易日时间
    *   end\_time - str 结束时间，8位字符串。为空表示当前时间
*   返回
    *   返回list，完整的交易日列表
*   备注
    *   结束时间可以填写未来时间，获取未来交易日。需要下载节假日列表。

## 获取交易时段

    get_trading_time(stockcode)
    

*   释义
    
    *   返回指定代码的交易时段
*   参数
    
    *   stockcode - str 合约代码（例如`600000.SH`）
*   返回
    
    *   list，返回交易时段列表，第一位是开始时间，第二位结束时间，第三位交易类型 （2 - 开盘竞价， 3 - 连续交易， 8 - 收盘竞价， 9 - 盘后定价）。时间单位为"秒"
*   备注
    
    *   股票代码错误时返回空列表
        
    *   跨天时以当前天0点为起始，前一天为负，下一天多86400
        
    *       #需要转换为datetime时，可以用以下方法转换
            import datetime as dt
            dt.datetime.combine(dt.date.today(), dt.time()) + dt.timedelta(seconds = 34200)
            
        

## 可转债基础信息的下载

    download_cb_data()
    

*   释义
    *   下载全部可转债信息
*   参数
    *   无
*   返回
    *   无
*   备注
    *   无

## 获取可转债基础信息

    get_cb_info(stockcode)
    

*   释义
    *   返回指定代码的可转债信息
*   参数
    *   stockcode - str 合约代码（例如`600000.SH`）
*   返回
    *   dict，可转债信息
*   备注
    *   需要先下载可转债数据

## 获取新股申购信息

    get_ipo_info(start_time, end_time)
    

*   释义
    
    *   返回所选时间范围的新股申购信息
*   参数
    
    *   start\_time: 开始日期（如：'20230327'）
    *   end\_time: 结束日期（如：'20230327'）
    *   start\_time 和 end\_time 为空则返回全部数据
*   返回
    
    *   list\[dict\]，新股申购信息
        
    *       securityCode - string 证券代码
            codeName - string 代码简称
            market - string 所属市场
            actIssueQty - int 发行总量，单位：股
            onlineIssueQty - int 网上发行量, 单位：股
            onlineSubCode - string 申购代码
            onlineSubMaxQty - int 申购上限, 单位：股
            publishPrice - float 发行价格
            isProfit - int 是否已盈利 0：上市时尚未盈利 1：上市时已盈利
            industryPe - float 行业市盈率
            afterPE - float 发行后市盈率
            
        

## 获取可用周期列表

    get_period_list()
    

*   释义
    
    *   返回可用周期列表
*   参数
    
    *   无
*   返回
    
    *   list 周期列表

## ETF申赎清单信息下载

    download_etf_info()
    

*   释义
    
    *   下载所有ETF申赎清单信息
*   参数
    
    *   无
*   返回
    
    *   无

## ETF申赎清单信息获取

    get_etf_info()
    

*   释义
    
    *   获取所有ETF申赎清单信息
*   参数
    
    *   无
*   返回
    
    *   dict 所有申赎数据

## 节假日下载

    download_holiday_data()
    

*   释义
    
    *   下载节假日数据
*   参数
    
    *   无
*   返回
    
    *   无

## 获取最新交易日k线数据

    get_full_kline(field_list = [], stock_list = [], period = '1m'
        , start_time = '', end_time = '', count = 1
        , dividend_type = 'none', fill_data = True)
    

*   释义
    
    *   获取最新交易日k线全推数据,仅支持最新一个交易日，不包含历史值
*   参数
    
    *   参考`get_market_data`函数
*   返回
    
    *   dict - {field: DataFrame}
